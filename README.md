# Duckdp - DuckDB Differential Privacy Extension

This repository is based on https://github.com/duckdb/extension-template, check it out if you want to build and ship your own DuckDB extension.

---

This extension, Duckdp, provides differential privacy functions for DuckDB, allowing you to perform privacy-preserving analytics on sensitive data. It integrates Google's differential privacy library to offer functions like `dp_sum` for computing differentially private aggregations.

## Prerequisites

### Managing dependencies
DuckDB extensions uses VCPKG for dependency management. This is **CRITICAL** for this extension as it uses protobuf and must be compiled with vcpkg's protobuf version to avoid compatibility issues.

Enabling VCPKG is very simple: follow the [installation instructions](https://vcpkg.io/en/getting-started) or just run the following:
```shell
git clone https://github.com/Microsoft/vcpkg.git
./vcpkg/bootstrap-vcpkg.sh
export VCPKG_TOOLCHAIN_PATH=`pwd`/vcpkg/scripts/buildsystems/vcpkg.cmake
```

**Important**: This extension requires specific dependencies that must be managed through vcpkg:
- `protobuf` - For serialization of differential privacy mechanisms
- `abseil` - Required by Google's differential privacy library
- `openssl` - For cryptographic operations
- `utf8-range` - Required for protobuf string validation

### Setting up the differential privacy library

This extension includes Google's differential privacy library as a git submodule in `third_party/differential-privacy`. The proto files in this library **MUST** be compiled using vcpkg's protobuf version to ensure compatibility.

## Building

### Step 1: Initialize submodules
```sh
git submodule update --init --recursive
```

### Step 2: Generate protobuf files
The differential privacy library contains proto files that need to be compiled. **Critical**: These must be compiled with the same protobuf version that vcpkg provides.

```sh
# Navigate to the differential privacy proto directory
cd third_party/differential-privacy/proto

# Compile proto files using vcpkg's protoc
# Make sure to use the protoc from your vcpkg installation
protoc --cpp_out=. proto/accounting/*.proto
```

### Step 3: Build the extension
Now to build the extension, run:
```sh
# Configure with cmake using vcpkg toolchain
cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=vcpkg_installed/vcpkg/scripts/buildsystems/vcpkg.cmake

# Build with ninja
ninja -C build
```

Or alternatively, use the Makefile:
```sh
make
```

The main binaries that will be built are:
```sh
./build/duckdb/duckdb
./build/duckdb/test/unittest
./build/duckdp.duckdb_extension
```
- `duckdb` is the binary for the duckdb shell with the extension code automatically loaded.
- `unittest` is the test runner of duckdb. Again, the extension is already linked into the binary.
- `duckdp.duckdb_extension` is the loadable binary as it would be distributed.

## Troubleshooting

### Common Build Issues

1. **Protobuf version mismatch errors**: 
   ```
   error: This file was generated by a newer version of protoc which is incompatible with your Protocol Buffer headers
   ```
   **Solution**: Ensure you're using vcpkg's protoc to compile the proto files, not a system-installed version.

2. **Missing utf8_range symbols**:
   ```
   undefined symbol: _ZN10utf8_range21SpanStructurallyValidE...
   ```
   **Solution**: The CMakeLists.txt includes both `utf8_range::utf8_range` and `utf8_range::utf8_validity` targets to resolve this.

3. **Missing differential privacy symbols**:
   Make sure all required source files from the differential privacy library are included in the build.

## Running the extension

To run the extension code, load it into DuckDB with unsigned extensions enabled:

```sh
./build/duckdb/duckdb -unsigned
```

Now you can load and use the differential privacy functions:
```sql
LOAD 'build/duckdp.duckdb_extension';

-- Example: Compute differentially private sum
-- Parameters: input_value, epsilon, lower_bound, upper_bound
SELECT * FROM dp_sum(1.0, 1.0, 0.0, 10.0);
```

Available functions:
- `dp_sum(input_value, epsilon, lower_bound, upper_bound)` - Computes a differentially private sum

## Running the tests
